
# Promote Dev Image to Release
# Promotes latest dev build to production release in BOTH ACRs
# - Keeps release copy in DEV ACR (for rollback/audit)
# - Pushes release copy to PROD ACR (for production deployment)
# - Deploys from PROD ACR to PROD App Service

name: Promote Dev to Release (Both ACRs)

on:
  push:
    tags:
      - 'v*.*.*'           # Triggers on semantic version tags (v1.0.0, v2.1.3, etc.)
      - 'V*.*.*'           # Also triggers on uppercase semantic version tags (V1.0.0, V2.1.3, etc.)
  workflow_dispatch:       # Allows manual trigger from GitHub Actions UI
    inputs:
      release_version:
        description: 'Release version (e.g., v1.0.0, v2.1.3)'
        required: true
        type: string
      dev_tag:
        description: 'Dev tag to promote (leave empty for latest)'
        required: false
        type: string
        default: 'latest'

env:
  DEV_REGISTRY: mysampleacr
  PROD_REGISTRY: mysampleprodacr
  IMAGE_NAME: sample-app

jobs:
  # Job 1: Promote to both ACRs using ACR Import
  promote-to-both-acrs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Determine release version from tag push or manual input
      - name: Set release version
        run: |
          # Check if triggered by tag push
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract version from tag
            RELEASE_VERSION="${GITHUB_REF#refs/tags/}"
            DEV_TAG="latest"
            echo "Triggered by tag push: $RELEASE_VERSION"
          else
            # Use manual input
            RELEASE_VERSION="${{ github.event.inputs.release_version }}"
            DEV_TAG="${{ github.event.inputs.dev_tag }}"
            echo "Triggered manually: $RELEASE_VERSION"
          fi
          
          # Validate version format
          if [[ ! "$RELEASE_VERSION" =~ ^[vV][0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Error: Invalid release version format. Expected: v1.0.0 or v1.0.0-beta"
            exit 1
          fi
          
          echo "Valid release version: $RELEASE_VERSION"
          echo "Dev tag to promote: $DEV_TAG"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
          echo "DEV_TAG=$DEV_TAG" >> $GITHUB_ENV

      # Authenticate with Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: false

      # Tag the source image with release version in DEV ACR (creates alias)
      - name: Tag release version in DEV ACR
        run: |
          echo "Creating release tag in DEV ACR..."
          
          # Create release tag pointing to existing dev image
          az acr repository show-tags \
            --name ${{ env.DEV_REGISTRY }} \
            --repository ${{ env.IMAGE_NAME }} \
            --output tsv | grep -q "^${{ env.DEV_TAG }}$"
          
          if [ $? -eq 0 ]; then
            # Get the manifest digest of the source image
            MANIFEST=$(az acr repository show \
              --name ${{ env.DEV_REGISTRY }} \
              --image ${{ env.IMAGE_NAME }}:${{ env.DEV_TAG }} \
              --query "digest" -o tsv)
            
            echo "Source image manifest: $MANIFEST"
            echo "MANIFEST=$MANIFEST" >> $GITHUB_ENV
            
            # Create release tag in DEV ACR using manifest digest
            az acr repository untag \
              --name ${{ env.DEV_REGISTRY }} \
              --image ${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }} \
              2>/dev/null || true
            
            # Tag using manifest digest
            docker pull ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}@$MANIFEST
            docker tag ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}@$MANIFEST \
              ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}
            docker push ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}
            
            echo "Release tag ${{ env.RELEASE_VERSION }} created in DEV ACR"
          else
            echo "Error: Source tag ${{ env.DEV_TAG }} not found in DEV ACR"
            exit 1
          fi
      # Free up disk space after pushing to PROD ACR
      # - name: Docker system prune after PROD push
      #   run: |
      #     echo "Pruning unused Docker data after PROD push..."
      #     docker system prune -af --volumes  

      # Import image from DEV ACR to PROD ACR with release tag
      - name: Import image to PROD ACR with release version
        run: |
          echo "Importing image from DEV ACR to PROD ACR using ACR import..."
          
          # Import with release version tag
          az acr import \
            --name ${{ env.PROD_REGISTRY }} \
            --source ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.DEV_TAG }} \
            --image ${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }} \
            --username ${{ secrets.DEV_ACR_USERNAME }} \
            --password ${{ secrets.DEV_ACR_PASSWORD }} \
            --force
          
          echo "Release ${{ env.RELEASE_VERSION }} imported to PROD ACR"

      # Import same image with 'latest' tag to PROD ACR
      - name: Import image to PROD ACR with latest tag
        run: |
          echo "Importing image as 'latest' tag to PROD ACR..."
          
          az acr import \
            --name ${{ env.PROD_REGISTRY }} \
            --source ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.DEV_TAG }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --username ${{ secrets.DEV_ACR_USERNAME }} \
            --password ${{ secrets.DEV_ACR_PASSWORD }} \
            --force
          
          echo "Latest tag imported to PROD ACR"

      # Verify imported images
      - name: Verify imported images in PROD ACR
        run: |
          echo "Verifying images in PROD ACR..."
          
          # Check release version tag exists
          az acr repository show-tags \
            --name ${{ env.PROD_REGISTRY }} \
            --repository ${{ env.IMAGE_NAME }} \
            --output tsv | grep "^${{ env.RELEASE_VERSION }}$"
          
          if [ $? -eq 0 ]; then
            echo "Verified: Release tag ${{ env.RELEASE_VERSION }} exists in PROD ACR"
          else
            echo "Error: Release tag not found in PROD ACR"
            exit 1
          fi
          
          # Check latest tag exists
          az acr repository show-tags \
            --name ${{ env.PROD_REGISTRY }} \
            --repository ${{ env.IMAGE_NAME }} \
            --output tsv | grep "^latest$"
          
          if [ $? -eq 0 ]; then
            echo "Verified: Latest tag exists in PROD ACR"
          else
            echo "Error: Latest tag not found in PROD ACR"
            exit 1
          fi

      # Summary
      - name: Promotion summary
        run: |
          echo "=== Promotion Complete (via ACR Import) ==="
          echo ""
          echo "Source:"
          echo "   ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.DEV_TAG }}"
          echo ""
          echo "DEV ACR (backup copy):"
          echo "   ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}"
          echo "   ${{ env.DEV_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.DEV_TAG }} (kept)"
          echo ""
          echo "PROD ACR (production - imported):"
          echo "   ${{ env.PROD_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}"
          echo "   ${{ env.PROD_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "Benefits of ACR Import:"
          echo "   - No Docker pull/push (faster)"
          echo "   - No local disk space used on runner"
          echo "   - Direct registry-to-registry transfer"
          echo "   - Preserves all image layers and metadata"

  # Job 2: Deploy from PROD ACR to PROD App Service
  deploy-to-prod:
    runs-on: ubuntu-latest
    needs: promote-to-both-acrs
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
      # Set release version from tag or manual input
      - name: Set release version
        run: |
          # Check if triggered by tag push
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            RELEASE_VERSION="${GITHUB_REF#refs/tags/}"
          else
            RELEASE_VERSION="${{ github.event.inputs.release_version }}"
          fi
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
          echo "Deploying to PROD App Service from PROD ACR: $RELEASE_VERSION"
      
      # Deploy to PROD Web App from PROD ACR
      - name: Deploy to PROD App Service
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'mysamplewebappprod001'
          slot-name: 'Production'
          # Deploy from PROD ACR (not DEV ACR)
          images: '${{ env.PROD_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}'
          publish-profile: ${{ secrets.PROD_WEBAPP_PUBLISHPROFILE }}
      
      # Deployment summary
      - name: Deployment summary
        run: |
          echo " Production Deployment Complete"
          echo ""
          echo "PROD App Service: https://mysamplewebappprod001.azurewebsites.net"
          echo "Image: ${{ env.PROD_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}"
          echo "Release: ${{ env.RELEASE_VERSION }}"
          echo ""
          echo "Environment Separation:"
          echo "   DEV ACR (${{ env.DEV_REGISTRY }}):"
          echo "     - Dev builds: dev-*, main-*, pr-*"
          echo "     - Release backup: ${{ env.RELEASE_VERSION }}"
          echo ""
          echo "   PROD ACR (${{ env.PROD_REGISTRY }}):"
          echo "     - Production releases only: ${{ env.RELEASE_VERSION }}"
          echo "     - Used by PROD App Service"
          echo ""
          echo "   DEV App Service: mysamplewebapp001"
          echo "   PROD App Service: mysamplewebappprod001"
