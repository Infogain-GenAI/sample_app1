---
# To set this up:
#  1. Copy this file to .github/workflows/pr-review.yml in your repository
#  2. Add your LLM_API_KEY to the repository secrets
#  3. Commit this file to your repository
#  4. Trigger the review by either:
#     - Adding the "review-this" label to any PR, OR
#     - Requesting openhands-agent as a reviewer
name: PR Review by OpenHands
 
on:
    # Trigger when a label is added or a reviewer is requested
    pull_request:
        types: [labeled, review_requested]

permissions:
    contents: read
    pull-requests: write
    issues: write

jobs:
    pr-review:
        # Run when review-this label is added OR openhands-agent is requested as reviewer
        if: |
            github.event.label.name == 'review-this' ||
            github.event.requested_reviewer.login == 'openhands-agent'
        runs-on: ubuntu-latest
        env:
            # Configuration (modify these values as needed)
            # LLM model to use, e.g. 'gpt-4o-mini', 'gpt-4', 'claude-3-opus'.
            # You can also configure this via a repository variable (e.g. vars.LLM_MODEL).
            LLM_MODEL: gpt-4o-mini
            # Optional base URL for self-hosted / OpenAI-compatible endpoints, e.g. 'https://api.openai.com/v1'.
            # Leave empty to use the default endpoint for your chosen provider.
            LLM_BASE_URL: ''
            # Review style: 'standard' for pragmatic review, 'roasted' for Linus-style
            REVIEW_STYLE: standard
            # PR context will be automatically provided by the agent script
            PR_NUMBER: ${{ github.event.pull_request.number }}
            PR_TITLE: ${{ github.event.pull_request.title }}
            PR_BODY: ${{ github.event.pull_request.body }}
            PR_BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
            PR_HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
            REPO_NAME: ${{ github.repository }}
        steps:
            - name: Checkout software-agent-sdk repository
              uses: actions/checkout@v4
              with:
                  repository: OpenHands/software-agent-sdk
                  path: software-agent-sdk

            - name: Checkout PR repository
              uses: actions/checkout@v4
              with:
                  # Fetch the full history to get the diff
                  fetch-depth: 0
                  path: pr-repo
                  # Check out the feature branch so agent can inspect the PR changes
                  ref: ${{ github.event.pull_request.head.ref }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.13'

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true

            - name: Install GitHub CLI
              run: |
                # Install GitHub CLI for posting review comments
                sudo apt-get update
                sudo apt-get install -y gh
                # Replace gh with a safe wrapper that posts review payloads via JSON
                # This avoids shell-quoting issues when the agent builds large/multiline bodies
                sudo mv /usr/bin/gh /usr/bin/gh.real || true
                cat > /usr/local/bin/gh << 'PY'
                #!/usr/bin/env python3
                import sys, os, json, subprocess, re
                args = sys.argv[1:]
                joined = ' '.join(args)
                try:
                    is_review_post = 'api' in args and 'pulls' in joined and 'reviews' in joined and '-X' in args and 'POST' in args
                except Exception:
                    is_review_post = False
                if is_review_post:
                    payload = {}
                    comments = []
                    i = 0
                    while i < len(args):
                        a = args[i]
                        if a == '-f' and i + 1 < len(args):
                            kv = args[i+1]
                            if '=' in kv:
                                k, v = kv.split('=', 1)
                                v = v.strip("'\"")
                                m = re.match(r"comments\[\]\[(.+)\]", k)
                                if m:
                                    keyname = m.group(1)
                                    if not comments or keyname in comments[-1]:
                                        comments.append({})
                                    comments[-1][keyname] = v
                                elif k.startswith('comments'):
                                    comments.append(v)
                                else:
                                    payload[k] = v
                            i += 2
                        else:
                            i += 1
                    if comments:
                        payload['comments'] = comments
                    # Find the repos/... path to construct API URL
                    repo_path = None
                    for p in args:
                        if p.startswith('repos/'):
                            repo_path = p
                            break
                    if not repo_path:
                        print('Could not determine repo path for gh api call', file=sys.stderr)
                        sys.exit(2)
                    api_url = 'https://api.github.com/' + repo_path
                    token = os.environ.get('GITHUB_TOKEN') or os.environ.get('GH_TOKEN')
                    if not token:
                        print('GITHUB_TOKEN not found in environment', file=sys.stderr)
                        sys.exit(3)
                    cmd = [
                        'curl', '-sS', '-X', 'POST',
                        '-H', f'Authorization: token {token}',
                        '-H', 'Accept: application/vnd.github+json',
                        '-H', 'Content-Type: application/json',
                        '-d', json.dumps(payload),
                        api_url,
                    ]
                    rc = subprocess.call(cmd)
                    sys.exit(rc)
                else:
                    # Delegate to the real gh binary for all other commands
                    gh_real = '/usr/bin/gh.real'
                    if not os.path.exists(gh_real):
                        # fallback to system gh if we didn't move it
                        gh_real = '/usr/bin/gh'
                    os.execv(gh_real, [gh_real] + args)
                PY
                sudo chmod +x /usr/local/bin/gh

            - name: Install OpenHands dependencies
              run: |
                  # Install OpenHands SDK and tools from local checkout
                  uv pip install --system ./software-agent-sdk/openhands-sdk ./software-agent-sdk/openhands-tools

            - name: Check required configuration
              env:
                  LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
              run: |
                  if [ -z "$LLM_API_KEY" ]; then
                    echo "Error: LLM_API_KEY secret is not set."
                    exit 1
                  fi

                  echo "PR Number: $PR_NUMBER"
                  echo "PR Title: $PR_TITLE"
                  echo "Repository: $REPO_NAME"
                  echo "LLM model: $LLM_MODEL"
                  if [ -n "$LLM_BASE_URL" ]; then
                    echo "LLM base URL: $LLM_BASE_URL"
                  fi

            - name: Run PR review
              env:
                  LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Change to the PR repository directory so agent can analyze the code
                  cd pr-repo

                  # Run the PR review script from the software-agent-sdk checkout
                  uv run python ../software-agent-sdk/examples/03_github_workflows/02_pr_review/agent_script.py

            - name: Upload logs as artifact
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: openhands-pr-review-logs
                  path: |
                      *.log
                      output/
                  retention-days: 7
